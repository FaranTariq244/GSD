#progress Log

## Learnings
- Database: PostgreSQL with pg client library
- Migration pattern: Custom SQL migration runner in src/migrate.ts
- Database connection: Pool exported as default from src/db.ts, configured via environment variables
- Migration files stored in packages/backend/migrations/ as .sql files
- Run migrations with: npm run migrate (in backend package)
- Database config: .env.example provides template for DB_HOST, DB_PORT, DB_NAME, DB_USER, DB_PASSWORD
- Authentication: JWT tokens stored in httpOnly cookies (7 day expiration)
- Auth middleware: authenticate function in src/middleware/auth.ts adds userId to request
- Password hashing: bcryptjs with salt rounds = 10
- JWT_SECRET: Required in .env for production, defaults to dev-secret in development

---

## Iteration 1 - Set up project structure
- Created monorepo using npm workspaces with packages/backend and packages/frontend
- Backend: Node.js + TypeScript + Express with basic health endpoint
- Frontend: Vite + React 19 + TypeScript (scaffolded with create-vite)
- Files changed:
  - Root: package.json (workspace config), .gitignore, README.md, PRD.md (added task checklist)
  - Backend: package.json, tsconfig.json, src/index.ts
  - Frontend: All Vite scaffolded files (updated package.json name to @gsd/frontend)
- Learnings for future iterations:
  - Project uses npm workspaces for monorepo structure
  - Backend runs on port 3000 by default
  - Frontend runs on port 5173 (Vite default)
  - Test command returns exit 0 for now (no tests yet)
  - Typecheck uses `tsc --noEmit` across both packages
  - PRD.md now has task checklist at the top (added in this iteration)
---

## Iteration 2 - Set up database schema and migrations
- Installed pg and @types/pg for PostgreSQL database client
- Created comprehensive database schema covering all tables from PRD data model
- Files changed:
  - packages/backend/package.json (added pg, node-pg-migrate, @types/pg, and migrate script)
  - packages/backend/migrations/1_initial_schema.sql (all 8 tables with indexes)
  - packages/backend/src/db.ts (pool connection with env config)
  - packages/backend/src/migrate.ts (custom migration runner)
  - packages/backend/.env.example (database and server config template)
- Learnings for future iterations:
  - Tables: users, accounts, account_members, boards, tasks, task_assignees, task_tags, comments, attachments
  - All tables follow PRD spec with proper foreign keys and cascade deletes
  - Migration runner tracks applied migrations in a migrations table
  - Migration runner uses transactions (BEGIN/COMMIT/ROLLBACK) for safety
  - Indexes added for common query patterns (board_id, column, task_id, user_id, tag)
  - Database can be initialized by running: npm run migrate (in backend package)
---

## Iteration 3 - Implement user signup/login authentication
- Installed bcryptjs, jsonwebtoken, and cookie-parser with type definitions
- Created authentication middleware (src/middleware/auth.ts) that validates JWT tokens from cookies
- Created auth routes (src/routes/auth.ts) with three endpoints:
  - POST /auth/signup: Creates user with hashed password, returns JWT in httpOnly cookie
  - POST /auth/login: Validates credentials, returns JWT in httpOnly cookie
  - POST /auth/logout: Clears authentication cookie
- Files changed:
  - packages/backend/package.json (added bcryptjs, jsonwebtoken, cookie-parser + types)
  - packages/backend/src/index.ts (added cookie-parser middleware and auth routes)
  - packages/backend/src/middleware/auth.ts (JWT authentication middleware)
  - packages/backend/src/routes/auth.ts (signup, login, logout endpoints)
  - packages/backend/.env.example (added JWT_SECRET)
  - PRD.md (marked task complete)
- Learnings for future iterations:
  - Auth uses JWT tokens stored in httpOnly cookies (secure, sameSite: lax)
  - Token expiration: 7 days
  - Password validation: minimum 8 characters
  - Email addresses are lowercased for consistent lookups
  - AuthRequest interface extends Express Request to add userId field
  - Import pattern: pool is exported as default from db.ts (use `import pool from '../db.js'`)
  - 401 responses for auth failures, 400 for validation errors, 500 for server errors
---

## Iteration 4 - Implement GET /me endpoint
- Added GET /me endpoint to retrieve current authenticated user information
- Endpoint uses authenticate middleware to verify JWT token from cookie
- Returns user object with id, name, email, and created_at (excludes password_hash)
- Files changed:
  - packages/backend/src/routes/auth.ts (added GET /me endpoint)
  - PRD.md (marked task complete)
- Learnings for future iterations:
  - GET /me endpoint pattern: Use authenticate middleware, query user by req.userId
  - Endpoint returns 404 if user not found, 500 for server errors
  - Response format matches signup/login: { user: { id, name, email, created_at } }
---

## Iteration 5 - Create account automatically on signup with single board
- Modified POST /auth/signup to create account, add user as owner, and create board in single transaction
- Uses database transaction (BEGIN/COMMIT/ROLLBACK) to ensure atomicity
- Creates account with name format: "{user_name}'s Team"
- Adds user to account_members table with role 'owner'
- Creates default board named "Team Board"
- Files changed:
  - packages/backend/src/routes/auth.ts (wrapped signup logic in transaction, added account/board creation)
  - PRD.md (marked task complete)
- Learnings for future iterations:
  - Use pool.connect() to get a client for transactions
  - Transaction pattern: BEGIN -> operations -> COMMIT/ROLLBACK -> finally release()
  - Account creation automatically creates: account -> account_members (owner) -> board
  - Default naming: "{user_name}'s Team" for account, "Team Board" for board
  - Always release database client in finally block
---

## Iteration 6 - Implement member invite system
- Created invites table migration to store invite tokens with email, account, and expiration
- Created POST /account/invite endpoint that generates secure invite tokens
- Endpoint validates user is a member of an account before allowing invites
- Prevents duplicate invites for same email to same account
- Prevents inviting users who are already members
- Generates secure random 32-byte hex token using crypto.randomBytes
- Invites expire after 7 days
- Files changed:
  - packages/backend/migrations/2_add_invites_table.sql (new migration)
  - packages/backend/src/routes/account.ts (new file with invite endpoint)
  - packages/backend/src/index.ts (registered account routes)
  - PRD.md (marked task complete)
- Learnings for future iterations:
  - Invite system uses invites table with token, email, account_id, invited_by, expires_at, used_at
  - Token generation: crypto.randomBytes(32).toString('hex') for secure random tokens
  - Invite expiration: 7 days from creation (matches JWT token expiration)
  - Validation checks: user is member, target not already member, no active invite exists
  - Email normalization: lowercase and trim before storing/comparing
  - Returns invite object with id, email, token, created_at, expires_at
---